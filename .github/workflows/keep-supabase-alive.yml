name: Keep Supabase Alive

# è§¸ç™¼æ¢ä»¶
on:
  schedule:
    # æ¯å¤© UTC 01:00 åŸ·è¡Œ (å³å°ç£æ™‚é–“ 09:00)
    - cron: '0 1 * * *'
  # å…è¨±æ‰‹å‹•è§¸ç™¼æ¸¬è©¦
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    name: Check Supabase Status
    
    steps:
      # 1. é¡¯ç¤ºé–‹å§‹åŸ·è¡Œæ™‚é–“
      - name: Show Start Time
        run: |
          echo "ğŸ•’ é–‹å§‹åŸ·è¡Œæª¢æŸ¥: $(date)"

      # 2. åŸ·è¡Œ Curl è«‹æ±‚ä¸¦æª¢æŸ¥çµæœ
      - name: Ping Supabase Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # æª¢æŸ¥ secret æ˜¯å¦å­˜åœ¨
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "âŒ éŒ¯èª¤: ç¼ºå°‘ Secret è¨­å®š (SUPABASE_URL æˆ– SUPABASE_KEY)"
            exit 1
          fi

          echo "ğŸ“¡ æ­£åœ¨é€£ç·šåˆ° Supabase: $SUPABASE_URL/rest/v1/trips?limit=1"

          # åŸ·è¡Œè«‹æ±‚
          # -s: éœé»˜æ¨¡å¼
          # -w: è¼¸å‡º HTTP ç‹€æ…‹ç¢¼
          # -X GET: GET è«‹æ±‚
          response=$(curl -s -w "\n%{http_code}" -X GET \
            "$SUPABASE_URL/rest/v1/trips?limit=1" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY")

          # è§£æå›æ‡‰
          # å–æœ€å¾Œä¸€è¡Œä½œç‚º http_code
          http_code=$(echo "$response" | tail -n1)
          # å–é™¤äº†æœ€å¾Œä¸€è¡Œä¹‹å¤–çš„æ‰€æœ‰å…§å®¹ä½œç‚º body
          body=$(echo "$response" | sed '$d')

          echo "----------------------------------------"
          echo "HTTP ç‹€æ…‹ç¢¼: $http_code"
          echo "----------------------------------------"

          # åˆ¤æ–·çµæœ
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… æˆåŠŸ: Supabase é‹ä½œæ­£å¸¸ (HTTP 200)"
            echo "å›æ‡‰å…§å®¹é è¦½: ${body:0:100}..." # åªé¡¯ç¤ºå‰100å­—å…ƒé¿å…æ—¥èªŒéé•·
          else
            echo "âŒ å¤±æ•—: Supabase å›æ‡‰ç•°å¸¸ (HTTP $http_code)"
            echo "å®Œæ•´å›æ‡‰å…§å®¹:"
            echo "$body"
            exit 1
          fi

      # 3. é¡¯ç¤ºå®Œæˆæ™‚é–“ (ç„¡è«–æˆåŠŸå¤±æ•—éƒ½æœƒåŸ·è¡Œ)
      - name: Show End Time
        if: always()
        run: |
          echo "ğŸ æª¢æŸ¥çµæŸ: $(date)"
